<!DOCTYPE html>
<meta charset="utf-8">

<style>
html {
	background:#30404D;
	color:#ffffff;
	font-family: -apple-system, 'Helvetica Neue', 'Helvetica', sans-serif;
}

a {
	color:
}


/*-------

slider

---------*/

.range-wrap {
  position: relative;
  margin: 0 auto 3rem;
}
.range {
  width: 100%;
}
.bubble {
  background: rgb(128,0,0);
  color: white;
  padding: 4px 12px;
  position: absolute;
  border-radius: 4px;
  left: 50%;
  transform: translateX(-50%);
}
.bubble::after {
  content: "";
  position: absolute;
  width: 2px;
  height: 2px;
  background: rgb(128,0,0);
  top: -1px;
  left: 50%;
}


</style>

<body>

<script type="text/javascript" src="//lib.aga.my/d3/6.7.0/d3.min.js"></script>
<script type="text/javascript" src="//lib.aga.my/d3/plugins/d3.comparator.js"></script>
<script type="text/javascript" src="//lib.aga.my/topojson/3.0.2/topojson.min.js"></script>
<script type="text/javascript" src="//lib.aga.my/moment/2.24.0/moment.min.js"></script>
<script type="text/javascript" src="//lib.aga.my/textures/1.2.3/textures.js"></script>
<script type="text/javascript" src="//lib.aga.my/chroma/2.1.1/chroma.min.js"></script>
<script type="text/javascript" src="//lib.aga.my/turf/5.1.16/turf.min.js"></script>


<link type="text/css" rel="stylesheet" href="//lib.aga.my/font/awesome/5.15.2/css/all.min.css"/>



<script>

var width = 960,
    height = 400;

var projection = d3.geoMercator()
    .center([0, 0 ])
    .scale(2800 + 5*100)
    .rotate([-109.45 + 5/2,-3.2]);

var svg = d3.select("body")
								.append("svg")
 									.attr('viewBox', [0,0,width,height].join(' ')) // fill screen
						 				.style('max-height', (innerHeight-200)+'px')
									;

var path = d3.geoPath()
    .projection(projection);


svg.append('defs')
	.html(`

	<filter id="fshadow02" filterUnits="objectBoundingBox" x="-50%" y="-50%" width="200%" height="200%">
		<feGaussianBlur in="SourceAlpha" stdDeviation="3" result="BlurAlpha"/>
		<feOffset in="BlurAlpha" dx="1" dy="1" result="OffsetBlurAlpha"/>
		<feMerge>
			<feMergeNode in="OffsetBlurAlpha"/>
			<feMergeNode in="SourceGraphic"/>
		</feMerge>
	</filter>


`);





//=====================
// create containers
//=====================

let g 							= svg.append("g"),

		map_border 			= svg.append("g").attr('class','map-border-states'),
		map_fill 				= svg.append("g").attr('class','map-fill-states'),
		map_label 			= svg.append("g").attr('class','map-label-states');

//		circles_border	= svg.append('g').attr('class','cities-malaysia-mouseover'),
//    circles					= svg.append('g').attr('class','cities-malaysia'),
//    circles_label		= svg.append('g').attr('class','cities-malaysia-label'),

//    page_title			= svg.append('text');











//=====================
// global variables
//=====================

let states,
    land,

//		timer,
//		playdate,
//		transition_duration = 500,
//
		comma = d3.format(',');






//=====================
// load data
//=====================

Promise.all([

	d3.json("malaysia.json"),

]).then(loaded);





function loaded(raw)	{


	//=====================
	// from mapv4.html
	//=====================

	console.group('%c' +'map', 'color:magenta');

	let malaysia = raw[0];



  states = topojson.feature(malaysia, malaysia.objects.states);
  land = topojson.feature(malaysia, malaysia.objects.land);

  //=====================
  // shift sabah/sarawak/labuan closer to semenanjung
  //=====================

  [land,states].forEach(d=>{
    d.features
      .forEach(d=>{
        d.geometry.coordinates.forEach(d=>{
          d[0].forEach(_shift);
        });
      });
  });

  function _shift(d)  {
    if (typeof d=='object' && d.length==2)  {
      if (d[0]>105) d[0] += -5;
    }
  }


	map_border.selectAll(".land").data(land.features)
    .enter()
      .append("path")
        .attr('class','land')
        .attr("d", path)
        .attr('stroke','steelblue')
        .attr('stroke-width',1)
        .attr('fill', 'none' )
  	    .attr('filter','url(#fshadow02)')

	map_fill.selectAll(".state").data(states.features)
	    .enter()
	      .append("path")
	        .attr('class','state')
	        .attr("d", path)
	        .attr('stroke','#666')
	        .attr('fill', '#30404D' )
	        .attr('stroke-width',.5)
	        .attr('fill-opacity',1)
	        .on('click',function(e,d){
	        	//console.log('d.properties',d.properties.id, d.properties.cases.negeri);
	        	window.prompt('map id: '+d.properties.id, d.properties.cases.negeri);
	        });

	console.groupEnd('map');
















	//====================================================================================
	//
	//====================================================================================


	let map_id = {
		1:"Johor",
		2:"Kedah",
		3:"Kelantan",
		4:"Kuala Lumpur",
		5:"Labuan",
		6:"Melaka",
		7:"Negeri Sembilan",
		8:"Pahang",
		9:"Perak",
		10:"Perlis",
		11:"Pulau Pinang",
		12:"Putrajaya",
		13:"Sabah",
		14:"Sarawak",
		15:"Selangor",
		16:"Terengganu",
	};

	// assign negeri name to map based on properties.id

	states.features.forEach(d=>{
		d.properties.negeri = map_id[ d.properties.id ];
	});



	mapCentroid();


}



//====================================================================================
//
//====================================================================================

function mapCentroid()	{
	console.group('%c' +'mapCentroid', 'color:magenta');

	map_fill.selectAll('.state')
		.each(function(d){

			//=====================
			// SVG getBBox centroid
			// https://developer.mozilla.org/en-US/docs/Web/API/SVGGraphicsElement/getBBox
			//=====================

			let bb = d3.select(this).node().getBBox();
			d.properties.bbox = bb;

			d.properties.centroid = {
																x:bb.x+(bb.width/2),
																y:bb.y+(bb.height/2)
															};

			//=====================
			// turf.js centerOfMass
			// https://turfjs.org/docs/#centerOfMass
			//=====================

			let center = turf.centerOfMass(d);
			d.properties.center = {
															x: projection(center.geometry.coordinates)[0],
															y: projection(center.geometry.coordinates)[1]
														};

			//=====================
			// custom offset to centerOfMass
			//=====================
			d.properties.offset = {
				"Johor"						:[-10, 10],
				"Melaka"					:[  0,  0],
				"Negeri Sembilan"	:[  0,  0],
				"Putrajaya"				:[  0,  0],
				"Kuala Lumpur"		:[  0,  0],
				"Selangor"				:[-10,-10],
				"Pulau Pinang"		:[  0,  0],

				"Kedah"						:[  0,  0],
				"Perak"						:[  0,  0],
				"Perlis"					:[  0,  0],

				"Pahang"					:[  0,  0],
				"Terengganu"			:[  0,  0],
				"Kelantan"				:[  0,-10],

				"Sabah"						:[-10,  0],
				"Sarawak"					:[ 20, 10],
				"Labuan"					:[  0,  0],
			}[d.properties.negeri];



		});



	let colors 	= [
									'lime',
									'yellow',
									'red',
								];

	states.features.sort(function(a,b){ return a.properties.bbox.x < b.properties.bbox.x });
	states.features.forEach((d,i)=>{
		d.properties.sequence = i;
	});


	console.log('states.features', states.features.map(d=>[d.properties.sequence, d.properties.id, d.properties.negeri]));


	let t = 100,
			delay = 1000;


	d3.selectAll('.state')
		.attr('fill-opacity',0)


	let l = map_label.selectAll('g').data(d3.shuffle(states.features));
	l.exit().remove();
	l.enter()
			.append('g')
				.attr('shape-rendering','geometricPrecision')
				.call(sel=>{


					let colors = [
													'#62D96B',
													'cyan',
												];

					//=====================
					// getBBox box
					//=====================

					sel.append('path')
						.attr('stroke',colors[1])
						.attr('stroke-width',1)
						.attr('fill','none')
						.attr('opacity',1)
						.attr('d',d=>[
							'M',
							[
								d.properties.bbox.x,
								d.properties.bbox.y
							],
							'L',
							[
								d.properties.bbox.x + d.properties.bbox.width,
								d.properties.bbox.y
							],
							[
								d.properties.bbox.x + d.properties.bbox.width,
								d.properties.bbox.y + d.properties.bbox.height
							],
							[
								d.properties.bbox.x,
								d.properties.bbox.y + d.properties.bbox.height
							],
							[
								d.properties.bbox.x,
								d.properties.bbox.y
							],
							'Z',
						].join(' '))
						.attr('stroke-dasharray',function(d){
							return 0+' '+Math.ceil(d3.select(this).node().getTotalLength())
						})
						.attr("stroke-dashoffset", 0)

					//=====================
					// offset path
					//=====================

					sel.append('line')
						.attr('class','line-centroid-centerOfMass')
						.attr('stroke',colors[0])
						.attr('x1', d=>d.properties.centroid.x)
						.attr('y1', d=>d.properties.centroid.y)
						.attr('x2', d=>d.properties.centroid.x)
						.attr('y2', d=>d.properties.centroid.y)
						.attr('stroke-width',1)
						.attr('opacity',1)

					sel.append('line')
						.attr('class','line-centerOfMass-offset')
						.attr('stroke','yellow')
						.attr('x1', d=>d.properties.center.x)
						.attr('y1', d=>d.properties.center.y)
						.attr('x2', d=>d.properties.center.x)
						.attr('y2', d=>d.properties.center.y)
						.attr('stroke-width',1)
						.attr('opacity',1)

					//=====================
					// bubbles
					//=====================

					sel.append('circle')
						.attr('class','getBBox-centroid')
						.attr('fill',colors[0])
						.attr('cx', d=>d.properties.centroid.x)
						.attr('cy', d=>d.properties.centroid.y)
						.attr('r', 0)
						.attr('opacity',1)


					sel.append('circle')
						.attr('class','centerOfMass')
						.attr('fill',colors[0])
						.attr('cx', d=>d.properties.centroid.x)
						.attr('cy', d=>d.properties.centroid.y)
						.attr('r', 0)
						.attr('opacity',1)

					sel.append('circle')
						.attr('class','centerOfMass-offset')
						.attr('fill','yellow')
						.attr('cx', d=>d.properties.center.x)
						.attr('cy', d=>d.properties.center.y)
						.attr('r', 0)
						.attr('opacity',1)

				})
			.merge(l)
				.call(sel=>{



					d3.timeout(()=>{

						//=====================
						// map
						//=====================

						d3.selectAll('.state')
							.attr('fill-opacity',0)
							.transition()
								.delay((d,i)=>500 + t + (d.properties.sequence * delay))
								.duration(t)
									.attr('fill','steelblue')
									.attr('fill-opacity',1)
							.transition()
								.delay(t)
								.duration(3000)
									.attr('fill-opacity',.1)


						//=====================
						// box
						//=====================

						sel.select('path')
							.transition()
								.delay((d,i)=>500 + t + (d.properties.sequence * delay))
								.duration(1000)
								.ease(d3.easeLinear)
									.attr('stroke-dasharray',function(d,i){
										let p = Math.ceil(d3.select(this).node().getTotalLength());
										//return p+' '+p;
										return [p,0].join(' ');
									})
							.transition()
								.delay(100)
								.duration(1000)
									.attr('opacity',.1)

						//=====================
						//
						//=====================

						sel.select('.getBBox-centroid')
							.transition()
									.delay(d=>500 + (t*5) + (d.properties.sequence*delay))
									.duration(t*2)
										.attr('r',3)
							.transition()
								.delay(1000)
									.duration(2000)
									.attr('opacity',.1)


						//=====================
						//
						//=====================


						t5 = sel.transition()
									.delay(d=>500 + (t*6) + (d.properties.sequence*delay))
									.duration(t*3)


						sel.select('.line-centroid-centerOfMass')
							.transition(t5)
										.attr('x2', d=>d.properties.center.x)
										.attr('y2', d=>d.properties.center.y)
										.attr('stroke','yellow')
							.transition()
								.delay(1000)
									.duration(2000)
									.attr('opacity',.1)

						sel.select('.centerOfMass')
							.transition(t5)
										.attr('cx', d=>d.properties.center.x)
										.attr('cy', d=>d.properties.center.y)
										.attr('r',3)
										.attr('fill','yellow')
							.transition()
								.delay(1000)
									.duration(2000)
									.attr('opacity',.1)

						//=====================
						//
						//=====================

						t6 = sel.transition()
									.delay(d=>500 + (t*7) + (d.properties.sequence*delay))
									.duration(t*4)



						sel.select('.line-centerOfMass-offset')
							.transition(t6)
										.attr('x2', d=>d.properties.center.x + d.properties.offset[0])
										.attr('y2', d=>d.properties.center.y + d.properties.offset[1])
										.attr('stroke','red')
							.transition()
								.delay(1000)
									.duration(2000)
									.attr('opacity',.1)

						sel.select('.centerOfMass-offset')
							.transition(t6)
										.attr('cx', d=>d.properties.center.x + d.properties.offset[0])
										.attr('cy', d=>d.properties.center.y + d.properties.offset[1])
										.attr('r',3)
										.attr('fill','red');


						//=====================
						//
						//=====================


					},1000);

				});



	//=====================
	// legends
	//=====================

	svg.append('g')
		.attr('transform','translate('+[width/2 - 150,50]+')')
		.style('cursor','pointer')
		.call(sel=>{

			sel.append('g')
				.attr('class','legend-bbox')
				.on('click', function(e,d)	{

					let sel = d3.select(this),
							tf = sel.classed('hidden');

					d3.selectAll('.getBBox')
						.transition()
							.delay((d,i)=>i*50)
								.attr('display', tf ? null : 'none')

					sel.classed('hidden',!tf);

				})
				.call(sel=>{

					sel.append('rect')
							.attr('fill',chroma('steelblue').alpha(.1).hex())
							.attr('stroke','#333')
							.attr('x',-3)
							.attr('y', -5)
							.attr('width', 200)
							.attr('height', 20)
							.attr('rx',3)
							.attr('ry',3)

					sel.append('rect')
							.attr('stroke', 'cyan' )
							.attr('stroke-width',.5)
							.attr('fill','none')
							.attr('x',7)
							.attr('y', -3)
							.attr('width', 16)
							.attr('height', 16)

					sel.append('text')
							.attr('x',30)
							.attr('y',10)
							.attr('font-size', '70%')
							.attr('fill','white')
							.text('getBBox()')

				})
				.attr('opacity',0)
				.transition()
					.delay(1000)
					.attr('opacity',1)



			sel.append('g')
				.attr('class','legend-bbox-centroid')
				.attr('transform','translate(0,20)')
				.on('click', function(e,d)	{

					let sel = d3.select(this),
							tf = sel.classed('hidden');

					d3.selectAll('.getBBox-centroid')
						.transition()
							.delay((d,i)=>i*50)
								.attr('display', tf ? null : 'none')

					sel.classed('hidden',!tf);

				})
				.call(sel=>{

					sel.append('rect')
							.attr('fill',chroma('steelblue').alpha(.1).hex())
							.attr('stroke','#333')
							.attr('x',-3)
							.attr('y', -5)
							.attr('width', 200)
							.attr('height', 20)
							.attr('rx',3)
							.attr('ry',3)

					sel.append('circle')
							.attr('fill', 'lime' )
							.attr('cx', 15)
							.attr('cy', 7)
							.attr('r', 3)

					sel.append('text')
							.attr('x',30)
							.attr('y',10)
							.attr('font-size', '70%')
							.attr('fill','white')
							.text('centroid from getBBox()')

				})
				.attr('opacity',0)
				.transition()
					.delay(2000)
					.attr('opacity',1)




			sel.append('g')
				.attr('class','legend-centerOfMass')
				.attr('transform','translate(0,40)')
				.on('click', function(e,d)	{

					let sel = d3.select(this),
							tf = sel.classed('hidden');

					d3.selectAll('.centerOfMass')
						.transition()
							.delay((d,i)=>i*50)
								.attr('display', tf ? null : 'none')

					sel.classed('hidden',!tf);

				})
				.call(sel=>{

					sel.append('rect')
							.attr('fill',chroma('steelblue').alpha(.1).hex())
							.attr('stroke','#333')
							.attr('x',-3)
							.attr('y', -5)
							.attr('width', 200)
							.attr('height', 20)
							.attr('rx',3)
							.attr('ry',3)


					sel.append('circle')
							.attr('fill', 'yellow' )
							.attr('cx', 15)
							.attr('cy', 7)
							.attr('r', 3)

					sel.append('text')
							.attr('x',30)
							.attr('y',10)
							.attr('font-size', '70%')
							.attr('fill','white')
							.text('centerOfMass')

				})
				.attr('opacity',0)
				.transition()
					.delay(3000)
					.attr('opacity',1)




			sel.append('g')
				.attr('class','legend-centerOfMass-offset')
				.attr('transform','translate(0,60)')
				.on('click', function(e,d)	{

					let sel = d3.select(this),
							tf = sel.classed('hidden');

					d3.selectAll('.centerOfMass-offset')
						.transition()
							.delay((d,i)=>i*50)
								.attr('fill','red')
								.attr('display', tf ? null : 'none')

					sel.classed('hidden',!tf);

				})
				.call(sel=>{

					sel.append('rect')
							.attr('fill',chroma('steelblue').alpha(.1).hex())
							.attr('stroke','#333')
							.attr('x',-3)
							.attr('y', -5)
							.attr('width', 200)
							.attr('height', 20)
							.attr('rx',3)
							.attr('ry',3)


					sel.append('circle')
							.attr('fill', 'red' )
							.attr('cx', 15)
							.attr('cy', 7)
							.attr('r', 3)

					sel.append('text')
							.attr('x',30)
							.attr('y',10)
							.attr('font-size', '70%')
							.attr('fill','white')
							.text('centerOfMass + custom offset')

				})
				.attr('opacity',0)
				.transition()
					.delay(4000)
					.attr('opacity',1)



		});

	console.groupEnd('mapCentroid');
}





</script>



<div>
		Finding map centroid using
		<a href="https://developer.mozilla.org/en-US/docs/Web/API/SVGGraphicsElement/getBBox" target="_blank" style="color:#ddd">svg getBBox</a> or
		<a href="https://turfjs.org/docs/#centerOfMass" target="_blank" style="color:#ddd">turf.js centerOfMass</a>
</div>
<br>
<button onclick="document.location='index.html'">Main Menu</button>
<button onclick="document.location='index10.html'">Back</button>
<button onclick="document.location='index12.html'">Next</button>




</body>
</html>
