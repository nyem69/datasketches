<!DOCTYPE html>
<meta charset="utf-8">

<style>
html {
	font-family: -apple-system, 'Helvetica Neue', 'Helvetica', sans-serif;
}
</style>

<body>

<script src="https://d3js.org/d3.v6.min.js"></script>
<script src="https://unpkg.com/topojson@3"></script>
<script type="text/javascript" src="//lib.aga.my/moment/2.24.0/moment.min.js"></script>
<script type="text/javascript" src="//lib.aga.my/textures/1.2.3/textures.js"></script>
<script type="text/javascript" src="//lib.aga.my/chroma/2.1.1/chroma.min.js"></script>
<script>

var width = 960,
    height = 400;


var projection = d3.geoMercator()
    .center([0, 0 ])
    .scale(2800 + 5*100)
    .rotate([-109.45 + 5/2,-3.2]);

var svg = d3.select("body").append("svg")
 .attr('viewBox', [0,0,width,height].join(' ')) // fill screen
;

var path = d3.geoPath()
    .projection(projection);


svg.append('defs')
	.html(`

	<filter id="fshadow01" filterUnits="objectBoundingBox" x="-50%" y="-50%" width="200%" height="200%">
		<feGaussianBlur in="SourceAlpha" stdDeviation="1.5" result="BlurAlpha"/>
		<feOffset in="BlurAlpha" dx="1" dy="1" result="OffsetBlurAlpha"/>
		<feMerge>
			<feMergeNode in="OffsetBlurAlpha"/>
			<feMergeNode in="SourceGraphic"/>
		</feMerge>
	</filter>

	<filter id="fshadow02" filterUnits="objectBoundingBox" x="-50%" y="-50%" width="200%" height="200%">
		<feGaussianBlur in="SourceAlpha" stdDeviation="3" result="BlurAlpha"/>
		<feOffset in="BlurAlpha" dx="1" dy="1" result="OffsetBlurAlpha"/>
		<feMerge>
			<feMergeNode in="OffsetBlurAlpha"/>
			<feMergeNode in="SourceGraphic"/>
		</feMerge>
	</filter>

	<filter id="fshadow03" filterUnits="objectBoundingBox" x="-50%" y="-50%" width="200%" height="200%">
		<feGaussianBlur in="SourceAlpha" stdDeviation="7" result="BlurAlpha"/>
		<feOffset in="BlurAlpha" dx="1" dy="1" result="OffsetBlurAlpha"/>
		<feMerge>
			<feMergeNode in="OffsetBlurAlpha"/>
			<feMergeNode in="SourceGraphic"/>
		</feMerge>
	</filter>

	<radialGradient id="Red" cx="30%" cy="30%" fx="30%" fy="30%" r="50%" gradientUnits="objectBoundingBox">
		<stop offset="0" style="stop-color:rgb(255,0,0)"/>
		<stop offset="1" style="stop-color:rgb(128,0,0)"/>
	</radialGradient>
	<radialGradient id="Yellow" cx="30%" cy="30%" fx="30%" fy="30%" r="50%" gradientUnits="objectBoundingBox">
		<stop offset="0" style="stop-color:rgb(255,255,0)"/>
		<stop offset="1" style="stop-color:rgb(128,128,0)"/>
	</radialGradient>
	<radialGradient id="Orange" cx="30%" cy="30%" fx="30%" fy="30%" r="50%" gradientUnits="objectBoundingBox">
		<stop offset="0" style="stop-color:#ff0"/>
		<stop offset="1" style="stop-color:#f90"/>
	</radialGradient>
	<radialGradient id="Cyan" cx="30%" cy="30%" fx="30%" fy="30%" r="50%" gradientUnits="objectBoundingBox">
		<stop offset="0" style="stop-color:rgb(0,255,255)"/>
		<stop offset="1" style="stop-color:rgb(0,128,128)"/>
	</radialGradient>
	<radialGradient id="WildStrawberry" cx="30%" cy="30%" fx="30%" fy="30%" r="50%" gradientUnits="objectBoundingBox">
		<stop offset="0" style="stop-color:rgb(255,10,155)"/>
		<stop offset="1" style="stop-color:rgb(128,5,78)"/>
	</radialGradient>
	<radialGradient id="Blue" cx="30%" cy="30%" fx="30%" fy="30%" r="50%" gradientUnits="objectBoundingBox">
		<stop offset="0" style="stop-color:rgb(0,0,255)"/>
		<stop offset="1" style="stop-color:rgb(0,0,128)"/>
	</radialGradient>
	<radialGradient id="Purple" cx="30%" cy="30%" fx="30%" fy="30%" r="50%" gradientUnits="objectBoundingBox">
		<stop offset="0" style="stop-color:rgb(140,35,255)"/>
		<stop offset="1" style="stop-color:rgb(70,18,128)"/>
	</radialGradient>
	<radialGradient id="Lime" cx="30%" cy="30%" fx="30%" fy="30%" r="50%" gradientUnits="objectBoundingBox">
		<stop offset="0" style="stop-color:rgb(127,255,0)"/>
		<stop offset="1" style="stop-color:rgb(64,128,0)"/>
	</radialGradient>
	<radialGradient id="Silver" cx="30%" cy="30%" fx="30%" fy="30%" r="50%" gradientUnits="objectBoundingBox">
		<stop offset="0" style="stop-color:#fff"/>
		<stop offset="1" style="stop-color:#999"/>
	</radialGradient>
	<radialGradient id="Brown" cx="30%" cy="30%" fx="30%" fy="30%" r="50%" gradientUnits="objectBoundingBox">
		<stop offset="0" style="stop-color:#fff"/>
		<stop offset="1" style="stop-color:#E18400"/>
	</radialGradient>
	<radialGradient id="SkyBlue" cx="30%" cy="30%" fx="30%" fy="30%" r="50%" gradientUnits="objectBoundingBox">
		<stop offset="0" style="stop-color:#fff"/>
		<stop offset="1" style="stop-color:#87CEFA"/>
	</radialGradient>
	<radialGradient id="Tomato" cx="30%" cy="30%" fx="30%" fy="30%" r="50%" gradientUnits="objectBoundingBox">
		<stop offset="0" style="stop-color:#fff"/>
		<stop offset="1" style="stop-color:#FF6347"/>
	</radialGradient>
`);


var g = svg.append("g");


//=====================
// global variables
//=====================

let states,
    land;

//=====================
// from mapv4.html
//=====================

d3.json("malaysia.json").then(function(malaysia) {

  states = topojson.feature(malaysia, malaysia.objects.states);
  land = topojson.feature(malaysia, malaysia.objects.land);

  //=====================
  // shift sabah/sarawak/labuan closer to semenanjung
  //=====================

  [land,states].forEach(d=>{
    d.features
      .forEach(d=>{
        d.geometry.coordinates.forEach(d=>{
          d[0].forEach(_shift);
        });
      });
  });

  function _shift(d)  {
    if (typeof d=='object' && d.length==2)  {
      if (d[0]>105) d[0] += -5;
    }
  }


	svg.append("g").attr('class','map-border-states')
		.selectAll(".land").data(land.features)
    .enter()
      .append("path")
        .attr('class','land')
        .attr("d", path)
        .attr('stroke','steelblue')
        .attr('stroke-width',1)
        .attr('fill', 'none' )
  	    .attr('filter','url(#fshadow02)')

	svg.append("g").attr('class','map-fill-states')
  	.selectAll(".state").data(states.features)
	    .enter()
	      .append("path")
	        .attr('class','state')
	        .attr("d", path)
	        .attr('stroke','#ccc')
	        .attr('fill', '#f2f2f2' )
	        .attr('stroke-width',.5)
	        .attr('fill-opacity',1)
	        .on('click',function(e,d){
	        	//console.log('d.properties',d.properties.id, d.properties.cases.negeri);
	        	window.prompt('map id: '+d.properties.id, d.properties.cases.negeri);
	        });


});





//=====================
// load districts from google sheets
// sheet: https://docs.google.com/spreadsheets/d/17vLxlZGl1cOTpjFqQhh1x_ABVKbh4muUOh1hFK0XYhg/edit?usp=sharing
// csv: https://docs.google.com/spreadsheets/d/e/2PACX-1vR94XOsvxFUtkF_csctKSZpAFmbFBN6_F7CKD9Boww_11al2PlMILTZOOCtC5FVC2keEqHW_KvQpBeC/pub?gid=572100186&single=true&output=csv
//=====================

d3.csv('https://docs.google.com/spreadsheets/d/e/2PACX-1vR94XOsvxFUtkF_csctKSZpAFmbFBN6_F7CKD9Boww_11al2PlMILTZOOCtC5FVC2keEqHW_KvQpBeC/pub?gid=572100186&single=true&output=csv')
  .then(function(raw){

  	console.group('%c' +'hotspot', 'color:magenta');
    console.log('raw.columns', raw.columns);
    //console.log('raw', raw);

    let data = [];
    raw.filter(d=>d.Longitude && d.Latitude)
        .forEach(d=>{

					//=====================
					// convert columns into arrays of [date, value]
					//=====================

          let k = {
          	total:[],
          	active:[],
					};

					raw.columns.forEach(j=>{

						// "Active 2020-04-20"
						let r1 = j.match(/^active\s+(\d+\-\d+\-\d+)$/i);

						// "2020-04-20"
						let r2 = j.match(/^(\d+\-\d+\-\d+)$/);

						if (r1)	{

							k.active.push({
								date	: r1[1],
								value	: +d[j],
								column: j,
								str		: d[j],
							});

						}else if (r2)	{
							k.total.push({
								date	: r2[1],
								value	: +d[j],
								column: j,
								str		: d[j],
							});

						}else	if (d[j]) {
						//}else	{
							k[j] = d[j];
						}


						// convert numeric
						['Longitude','Latitude','Population','kod_daerah','no','sort D','sort E'].forEach(j=>{
							k[j] = +k[j];
						});

						// lowercase
						k.longitude = k.Longitude;
						k.latitude = k.Latitude;

						// shift longitude
						if (k['longitude'] > 105) k['longitude'] += -5;

						// max active date
						k.max_active_date = d3.max(k.active, d=>d.date);
						let p1 = k.active.find(d=>d.date==k.max_active_date);
						k.latest_active_value = p1 && p1.value || null;

						// max total date
						k.max_total_date = d3.max(k.total, d=>d.date);
						let p2 = k.total.find(d=>d.date==k.max_total_date);
						k.latest_total_value = p2 && p2.value || null;

					});

					data.push(k);

        });


		let max_date = d3.max(data, d=>d.max_active_date);
    console.log('max_date', max_date);

    // filter data with latest date
    data = data.filter(d=>d.max_active_date==max_date && d.latest_active_value);

		// sort descending
		data.sort((a,b)=>{ return a.latest_active_value > b.latest_active_value });

    console.log('data', data);


		//=====================
		// radius scale
		//=====================

    let max_value = d3.max(data, d=>d.latest_active_value);
		//let scaleRadius = d3.scaleLinear().domain([0,max_value]).range([0,10]);
		let scaleRadius = d3.scaleSqrt().domain([0,max_value]).range([0,15]);
		let scaleColorCircle = d3.scaleLinear()
														//.domain([0,50,100,500,max_value])
														//.range( d3.schemeYlOrBr[5] );
														.domain([0,20,40,max_value])
														.range(['white','yellow','orange','crimson'])



		var color = d3.scaleThreshold()
		    .domain([0, 40])
		    .range(["lime", "yellow", "red"]);


		// large circle to capture mouseover
    svg.append('g').attr('class','cities-malaysia-mouseover')
      .selectAll('circle').data(data)
      .enter()
        .append('circle')
          .attr('cx', d=>projection([d.longitude,d.latitude])[0])
          .attr('cy', d=>projection([d.longitude,d.latitude])[1])
          .attr('r',d=>(scaleRadius(d.latest_active_value)||0)+10)
          .attr('fill',d=>scaleColorCircle(d.latest_active_value))
          .attr('stroke',d=>scaleColorCircle(d.latest_active_value))
          .attr('fill-opacity',.1)
          .attr('stroke-opacity',.2)
          .attr('stroke-width',.5)
          .on('mouseover',function(e,d){
          	d3.select('.cities-malaysia-label')
          		.selectAll('text')
				      	.attr('display',k=>k.Daerah==d.Daerah ? 'block':'none')
          })



		// circle fill
    svg.append('g').attr('class','cities-malaysia')
    	//.attr('pointer-events','none')
      .selectAll('circle').data(data)
      .enter()
        .append('circle')
          .attr('cx', d=>projection([d.longitude,d.latitude])[0])
          .attr('cy', d=>projection([d.longitude,d.latitude])[1])
          .attr('r',d=>scaleRadius(d.latest_active_value))
          //.attr('stroke','#fff')
          //.attr('stroke-width',1)
          //.attr('fill',d=>scaleColorCircle(d.latest_active_value)||0)
          //.attr('fill-opacity',.8)
          .attr('fill',d=>d.latest_active_value > 500 ? 'url(#Red)'
          								: d.latest_active_value > 100 ? 'url(#Orange)'
          								: d.latest_active_value > 20 ? 'url(#Yellow)'
          								: 'url(#Lime)'
          )
          .attr('filter','url(#fshadow01)')
          .on('mouseover',function(e,d){

          	d3.select('.cities-malaysia-label')
          		.selectAll('text')
				      	.attr('display',k=>k.Daerah==d.Daerah ? 'block':'none')

          })




		// text

		let comma = d3.format(',');

    svg.append('g').attr('class','cities-malaysia-label')
    	.attr('pointer-events','none')
      .selectAll('text').data(data.filter(d=>d.latest_active_value > 0))
		    .enter()
		      .append('text')
		        .attr('display','none')
		        .attr('text-anchor','middle')
		        .attr('font-weight',500)
		        .attr('transform',d=>'translate('+[
		        												projection([d.longitude,d.latitude])[0],
		        												projection([d.longitude,d.latitude])[1] - 30
		        										]+')')
		        .call(sel=>{


		        	sel.append('tspan')
		        		.attr('x',d=>0)
		        		.attr('y',d=>0)
		        		.attr('stroke','#fff')
		        		.attr('fill','#fff')
		        		.attr('stroke-width',2)
		        		.attr('font-size','60%')
		        		.attr('filter','url(#fshadow01)')
		        		.text(d=>d.Daerah)

		        	sel.append('tspan')
		        		.attr('x',d=>0)
		        		.attr('dy','1em')
		        		.attr('stroke','#fff')
		        		.attr('fill','#fff')
		        		.attr('stroke-width',2)
		        		.attr('filter','url(#fshadow01)')
		        		.text(d=>comma(d.latest_active_value))

		        	sel.append('tspan')
		        		.attr('x',d=>0)
		        		.attr('y',d=>0)
		        		.attr('fill','steelblue')
		        		.attr('font-size','60%')
		        		.text(d=>d.Daerah)

		        	sel.append('tspan')
		        		.attr('x',d=>0)
		        		.attr('dy','1em')
		        		.attr('fill','crimson')
		        		.text(d=>comma(d.latest_active_value))

		        })





		//=====================
		// map color by total active cases by state
		//=====================

		let active_cases_by_states = d3.groups(data, d=>d.Negeri)
												.map(d=>{
													return {
														negeri	: d[0],
														value		: d3.sum(d[1], d=>d.latest_active_value),
													}
												});

		console.log('active_cases_by_states',active_cases_by_states);

		// join map properties.id -> active_cases_by_states.negeri

		let map_id = {
			1:"Johor",
			2:"Kedah",
			3:"Kelantan",
			4:"Perlis",
			5:"Labuan",
			6:"Melaka",
			7:"Negeri Sembilan",
			8:"Pahang",
			9:"Perak",
			10:"Putrajaya",
			11:"Pulau Pinang",
			12:"Kuala Lumpur",
			13:"Sabah",
			14:"Sarawak",
			15:"Selangor",
			16:"Terengganu",
		};

		states.features.forEach(d=>{
			d.properties.cases = active_cases_by_states.find(k=>k.negeri == map_id[ d.properties.id ] );
		});

		console.log('states', states);

		let max_by_states = d3.max(states.features,d=>d.properties.cases.value);
		let scaleColor = d3.scaleLinear()
												.domain([0,50,100,500,max_by_states])
												.range( d3.schemeYlGnBu[5] );
												//.range( d3.schemeYlOrRd[5] );

		//=====================
		// textures.js
		//=====================
		// https://riccardoscalco.it/textures/

		states.features.forEach(d=>{

			let t = textures.lines()
						.size(4)
						.strokeWidth(1)
						.shapeRendering("crispEdges")

						// https://gka.github.io/chroma.js/
						.stroke( chroma(scaleColor(d.properties.cases.value)).brighten().brighten().hex() )
						.background( chroma(scaleColor(d.properties.cases.value)).brighten().hex() );

			d.properties.cases.texture = t;
			svg.call(t);

		});



    d3.select('.map-fill-states').selectAll(".state")
        .attr('fill',d=>d.properties.cases.texture.url())
      	.attr('stroke','#999')
      	.attr('fill-opacity',.8)

		//=====================
		// title
		//=====================
		svg.append('text')
			.attr('y','30%')
			.attr('text-anchor','middle')
			.attr('fill','steelblue')
			.call(sel=>{

				sel.append('tspan')
					.attr('x','46%')
					.attr('font-size','120%')
					.text('Active covid-19 cases by districts');

				sel.append('tspan')
					.attr('x','46%')
					.attr('dy','1.2em')
					.text(moment(max_date).format('D MMM YYYY'));

			});



		console.groupEnd('hotspot');
  });



</script>



<br>
<p>SVG
	<a href="http://tutorials.jenkov.com/svg/svg-gradients.html" target="_blank">gradients</a>
	and
	<a href="https://www.smashingmagazine.com/2015/05/why-the-svg-filter-is-awesome/" target="_blank">filters</a>
</p>

<br>
<button onclick="document.location='index.html'">Main Menu</button>
<button onclick="document.location='index7.html'">Back</button>
<!--
<button onclick="document.location='index8.html'">Next</button>
-->
</body>
</html>
